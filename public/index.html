<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zipper</title>
    <style>
        :root {
            --gemini-bg: #131314;
            --gemini-card: #1e1f20;
            --gemini-blue: #4285f4;
            --gemini-purple: #9b72cb;
            --gemini-red: #d93025;
            --gemini-green: #34a853;
            --text-primary: #e3e3e3;
            --text-secondary: #c4c7c5;
            --border-color: #444746;
            --input-bg: #131314;
            --accent-gradient: linear-gradient(74deg, #4285f4 0, #9b72cb 9%, #d96570 20%, #131314 100%);
            --gemini-gradient: linear-gradient(90deg, #4285f4, #9b72cb, #d96570);
        }

        body {
            font-family: 'Google Sans', 'Inter', sans-serif;
            background-color: var(--gemini-bg);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            background: var(--gemini-card);
            padding: 48px;
            border-radius: 28px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        }

        .lang-switch {
            position: absolute;
            top: 48px;
            right: 48px;
            display: flex;
            gap: 8px;
            background: var(--gemini-bg);
            padding: 4px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .lang-btn {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: var(--text-secondary);
            border: none;
        }

        .lang-btn.active {
            background: var(--gemini-blue);
            color: white;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 500;
            margin-bottom: 2rem;
            background: var(--gemini-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h1::before {
            content: '';
            width: 32px;
            height: 32px;
            background: var(--gemini-gradient);
            mask: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z'/%3E%3C/svg%3E") no-repeat center;
            -webkit-mask: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z'/%3E%3C/svg%3E") no-repeat center;
        }

        .input-group {
            position: relative;
            margin-bottom: 32px;
            display: flex;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 32px;
            padding: 8px 8px 8px 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-group:focus-within {
            border-color: transparent;
            box-shadow: 0 0 0 2px var(--gemini-purple);
        }

        input[type="text"] {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            padding: 12px 0;
        }

        button {
            padding: 12px 28px;
            border-radius: 24px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .scan-btn {
            background: var(--gemini-blue);
        }

        .scan-btn:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        #folderTree {
            margin-top: 24px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            overflow: hidden;
            display: none;
            background-color: var(--gemini-bg);
        }

        .tree-header {
            padding: 12px 24px;
            background-color: rgba(255,255,255,0.05);
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 40px 1fr 200px;
            align-items: center;
            gap: 16px;
            border-radius: 12px 12px 0 0;
        }

        .root-info-bar {
            padding: 8px 24px;
            background-color: rgba(66, 133, 244, 0.1);
            border-bottom: 1px solid rgba(66, 133, 244, 0.2);
            font-size: 13px;
            color: var(--gemini-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .root-info-bar .root-label {
            font-weight: 600;
            opacity: 0.8;
        }

        .root-info-bar .root-path {
            opacity: 0.6;
            font-family: 'Google Sans Mono', monospace;
            font-size: 11px;
        }

        #selectAllCheckbox {
            width: 18px;
            height: 18px;
            accent-color: var(--gemini-purple);
            cursor: pointer;
            justify-self: center;
        }

        .tree-header span {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tree-header span:hover {
            color: var(--text-primary);
        }

        .sort-icon::after {
            content: '‚Üï';
            font-size: 10px;
            opacity: 0.5;
        }

        .sort-asc::after { content: '‚Üë'; opacity: 1; color: var(--gemini-blue); }
        .sort-desc::after { content: '‚Üì'; opacity: 1; color: var(--gemini-blue); }

        #folderList {
            max-height: 350px;
            overflow-y: auto;
            padding: 0;
        }

        .folder-item {
            padding: 10px 24px;
            display: grid;
            grid-template-columns: 40px 1fr 200px;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .folder-item:hover {
            background-color: rgba(255,255,255,0.05);
        }

        .folder-item.file-item {
            background-color: rgba(66, 133, 244, 0.03);
        }

        .folder-item.file-item:hover {
            background-color: rgba(66, 133, 244, 0.08);
        }

        .folder-icon {
            font-size: 18px;
            min-width: 24px;
            display: flex;
            justify-content: center;
        }

        .folder-mtime {
            font-size: 12px;
            color: #80868b;
            font-family: 'Google Sans Mono', monospace;
            text-align: right;
            padding-right: 8px;
        }

        .folder-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--gemini-purple);
            border-radius: 4px;
            justify-self: center;
        }

        .folder-item label {
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            white-space: nowrap;
        }

        .folder-name-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0;
            max-width: 300px;
        }

        .folder-path-text {
            opacity: 0.3;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .folder-depth-0 .folder-label-container { padding-left: 0; }
        .folder-depth-1 .folder-label-container { padding-left: 20px; }
        .folder-depth-2 .folder-label-container { padding-left: 40px; }
        .folder-depth-3 .folder-label-container { padding-left: 60px; }

        .folder-label-container {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .root-folder-item {
            background-color: rgba(66, 133, 244, 0.05);
            border-left: 3px solid var(--gemini-blue);
            padding-left: 21px; /* 24 - 3 */
        }

        .root-folder-item:hover {
            background-color: rgba(66, 133, 244, 0.08);
        }

        #compressBtn {
            width: 100%;
            margin-top: 32px;
            background: var(--gemini-gradient);
            padding: 18px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 32px;
            display: none;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.2);
        }

        #compressBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.3);
        }

        /* ËøõÂ∫¶Âç°ÁâáÊ†∑ÂºèÈáçÊûÑ */
        .progress-card {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            margin-top: 48px; /* Â¢ûÂä†‰∏äÊñπÈó¥Ë∑ù */
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-title {
            font-size: 18px;
            font-weight: 600;
            background: var(--gemini-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .progress-stats {
            font-family: 'Google Sans Mono', monospace;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .progress-bar-wrapper {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: var(--gemini-gradient);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(66, 133, 244, 0.5);
        }

        .controls {
            display: flex;
            gap: 16px;
        }


        .btn-pause { background-color: #3c4043; color: var(--text-primary); flex: 1; }
        .btn-resume { background: var(--gemini-blue); flex: 1; display: none; }
        .btn-cancel { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); flex: 1; }
        .btn-cancel:hover { background-color: rgba(255,255,255,0.05); }

        /* Êó•ÂøóÁ™óÂè£ - ÊûÅÁÆÄ Gemini È£éÊ†º */
        .log-card {
            margin-top: 32px;
            display: none;
        }

        .log-card-header {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 16px;
            padding-left: 8px;
        }

        .log-container {
            background-color: rgba(255,255,255,0.02);
            color: var(--text-secondary);
            padding: 12px;
            font-family: 'Google Sans Mono', 'Inter', monospace;
            font-size: 13px;
            height: 320px;
            overflow-y: auto;
            line-height: 1.6;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .log-item {
            margin-bottom: 4px;
            display: flex;
            gap: 12px;
            padding: 6px 10px;
            border-radius: 6px;
            transition: background 0.2s;
            align-items: flex-start;
        }

        .log-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .log-time { 
            color: #80868b; 
            font-size: 11px; 
            min-width: 65px; 
            padding-top: 1px;
            font-family: 'Google Sans Mono', monospace;
        }
        
        .log-content {
            word-break: break-all;
            flex: 1;
        }
        .log-msg-success { color: var(--gemini-green); }
        .log-msg-error { color: var(--gemini-red); }
        .log-msg-info { color: var(--text-primary); }

        #result {
            margin-top: 40px;
            padding: 32px;
            border-radius: 24px;
            background: rgba(52, 168, 83, 0.05);
            border: 1px solid rgba(52, 168, 83, 0.2);
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 500;
            color: #80868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            font-size: 14px;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success { background: rgba(52, 168, 83, 0.1); color: var(--gemini-green); }
        .badge-error { background: rgba(217, 48, 37, 0.1); color: var(--gemini-red); }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: var(--gemini-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3c4043; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="lang-switch">
            <button class="lang-btn active" data-lang="zh">‰∏≠</button>
            <button class="lang-btn" data-lang="en">EN</button>
        </div>

        <h1 data-i18n="title">Zipper</h1>
        
        <div class="input-group">
            <input type="text" id="folderPath" data-i18n-placeholder="pathPlaceholder" placeholder="Enter parent folder path (e.g. D:\Photos)" required>
            <button id="scanBtn" class="scan-btn" data-i18n="scanBtn">Scan Folders</button>
        </div>

        <div id="folderTree">
            <div class="tree-header">
                <input type="checkbox" id="selectAllCheckbox">
                <span id="sortName" class="sort-icon" data-i18n="sortByName">Name</span>
                <span id="sortTime" class="sort-icon" data-i18n="sortByTime">Date Modified</span>
            </div>
            <div id="folderList"></div>
        </div>

        <button id="compressBtn" data-i18n="startBtn">Start Compression</button>

        <div id="progressCard" class="progress-card">
            <div class="progress-header">
                <div class="progress-title" id="progressTitle" data-i18n="initializing">Initializing...</div>
                <div class="progress-stats" id="progressStats">0 / 0</div>
            </div>
            <div class="progress-bar-wrapper">
                <div id="progressBarFill" class="progress-bar-fill"></div>
            </div>
            
            <div class="controls" id="controls">
                <button id="pauseBtn" class="btn-pause" data-i18n="pause">Pause</button>
                <button id="resumeBtn" class="btn-resume" data-i18n="resume">Resume</button>
                <button id="cancelBtn" class="btn-cancel" data-i18n="cancel">Cancel</button>
            </div>
        </div>

        <div id="logCard" class="log-card">
            <div class="log-card-header" data-i18n="logHeader">Activity Log</div>
            <div id="logContainer" class="log-container"></div>
        </div>

        <div id="result"></div>
    </div>

    <script>
        const i18n = {
            zh: {
                title: 'Zipper',
                pathPlaceholder: 'ËØ∑ËæìÂÖ•Áà∂Á∫ßÊñá‰ª∂Â§πÁªùÂØπË∑ØÂæÑ (‰æãÂ¶Ç: D:\\Photos)',
                scanBtn: 'Êâ´ÊèèÁõÆÂΩï',
                scanning: 'Ê≠£Âú®Êâ´Êèè...',
                selectFolders: 'ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§π',
                selectAll: 'ÂÖ®ÈÄâ / ÂèñÊ∂à',
                deselectAll: 'ÂèñÊ∂àÂÖ®ÈÄâ',
                sortByName: 'ÂêçÁß∞',
                sortByTime: '‰øÆÊîπÊó•Êúü',
                startBtn: 'ÂºÄÂßãÊâπÈáèÂéãÁº©',
                initializing: 'ÂáÜÂ§áÂ§ÑÁêÜ...',
                optimizing: 'Ê≠£Âú®‰ºòÂåñÂõæÁâá...',
                processingComplete: 'Â§ÑÁêÜÂÆåÊàê',
                pause: 'ÊöÇÂÅú‰ªªÂä°',
                resume: 'ÁªßÁª≠‰ªªÂä°',
                taskPaused: '‰ªªÂä°Â∑≤ÊöÇÂÅú',
                cancel: 'ÂèñÊ∂à‰ªªÂä°',
                close: 'ÂÖ≥Èó≠ËøõÂ∫¶',
                logHeader: 'Â§ÑÁêÜÊó•Âøó',
                successTitle: 'ÂéãÁº©‰ªªÂä°Â∑≤ÂÆåÊàê',
                processedCount: 'ÊàêÂäüÂ§ÑÁêÜ‰∫Ü {count} ‰∏™Êñá‰ª∂',
                tableFile: 'Êñá‰ª∂Âêç',
                tableOriginal: 'ÂéüÂ§ßÂ∞è',
                tableOptimized: 'ÂéãÁº©Âêé',
                tableStatus: 'Áä∂ÊÄÅ',
                tableSuccess: 'ÊàêÂäü',
                tableError: 'Â§±Ë¥•',
                checkLog: 'Êõ¥Â§öÁªìÊûúËØ∑Êü•Áúã‰∏äÊñπÊó•Âøó',
                initLog: 'Ê≠£Âú®ÂàùÂßãÂåñ {count} ‰∏™Êñá‰ª∂Â§πÁöÑ‰ºòÂåñ‰ªªÂä°...',
                cancelConfirm: 'Á°ÆÂÆöË¶ÅÂèñÊ∂àÂΩìÂâç‰ªªÂä°ÂêóÔºü',
                networkError: 'ÁΩëÁªúÈîôËØØ',
                optimized: 'Â∑≤‰ºòÂåñ',
                failed: 'Â§±Ë¥•',
                cancelled: '‰ªªÂä°Â∑≤ÊâãÂä®ÂèñÊ∂à'
            },
            en: {
                title: 'Zipper',
                pathPlaceholder: 'Enter parent folder path (e.g. D:\\Photos)',
                scanBtn: 'Scan Folders',
                scanning: 'Scanning...',
                selectFolders: 'Select Target Folders',
                selectAll: 'Select All',
                deselectAll: 'Deselect All',
                sortByName: 'Name',
                sortByTime: 'Date Modified',
                startBtn: 'Start Compression',
                initializing: 'Initializing...',
                optimizing: 'Optimizing Images...',
                processingComplete: 'Processing Complete',
                pause: 'Pause',
                resume: 'Resume',
                taskPaused: 'Task Paused',
                cancel: 'Cancel',
                close: 'Close',
                logHeader: 'Activity Log',
                successTitle: 'Optimization Successful',
                processedCount: 'Processed {count} files successfully',
                tableFile: 'File',
                tableOriginal: 'Original',
                tableOptimized: 'Optimized',
                tableStatus: 'Result',
                tableSuccess: 'Success',
                tableError: 'Error',
                checkLog: 'Check activity log for full details',
                initLog: 'Initializing optimization for {count} folders...',
                cancelConfirm: 'Cancel current task?',
                networkError: 'Network error',
                optimized: 'Optimized',
                failed: 'Failed',
                cancelled: 'Task cancelled by user'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'zh';

        function updateUI() {
            const langData = i18n[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (langData[key]) el.textContent = langData[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (langData[key]) el.placeholder = langData[key];
            });
            
            // Update active state of lang buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-lang') === currentLang);
            });
        }

        // Initialize Language
        updateUI();

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentLang = btn.getAttribute('data-lang');
                localStorage.setItem('lang', currentLang);
                updateUI();
            });
        });

        const scanBtn = document.getElementById('scanBtn');
        const compressBtn = document.getElementById('compressBtn');
        const folderPathInput = document.getElementById('folderPath');
        const folderTree = document.getElementById('folderTree');
        const folderList = document.getElementById('folderList');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const sortNameBtn = document.getElementById('sortName');
        const sortTimeBtn = document.getElementById('sortTime');
        const resultDiv = document.getElementById('result');
        
        const progressCard = document.getElementById('progressCard');
        const progressBarFill = document.getElementById('progressBarFill');
        const progressTitle = document.getElementById('progressTitle');
        const progressStats = document.getElementById('progressStats');
        const logCard = document.getElementById('logCard');
        const logContainer = document.getElementById('logContainer');
        const controls = document.getElementById('controls');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        let isAllSelected = false;
        let eventSource = null;
        let currentFolders = [];
        let currentFiles = [];
        let currentRoot = null;
        let sortConfig = { key: null, direction: 'asc' };

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log-item';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            div.innerHTML = `<span class="log-time">${time}</span><span class="log-content log-msg-${type}">${message}</span>`;
            logContainer.prepend(div);
            // Á°Æ‰øùÊó•ÂøóÊ°ÜÂèØËßÅ
            logCard.style.display = 'block';
        }

        function formatTime(ms) {
            if (!ms) return '-';
            const date = new Date(ms);
            return date.toLocaleString([], { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        function renderFolderList() {
            if (!folderList) return;
            folderList.innerHTML = '';
            
            // 1. Êõ¥Êñ∞È°∂ÈÉ®ÁöÑÊ†πÁõÆÂΩï‰ø°ÊÅØÊù° (Root Info Bar)
            const existingRootBar = folderTree.querySelector('.root-info-bar');
            if (existingRootBar) existingRootBar.remove();

            if (currentRoot) {
                const rootBar = document.createElement('div');
                rootBar.className = 'root-info-bar';
                rootBar.innerHTML = `
                    <span class="root-icon">üè†</span>
                    <span class="root-label">Root:</span>
                    <span class="root-path">${currentRoot.path}</span>
                    ${currentRoot.hasImages ? '<span style="margin-left:auto; font-size:10px; padding:2px 8px; background:rgba(66,133,244,0.2); border-radius:10px;">Contains Images</span>' : ''}
                `;
                folderTree.insertBefore(rootBar, folderTree.querySelector('.tree-header'));
            }

            // 2. ËøáÊª§ÊéâÂàóË°®‰∏≠ÁöÑÊ†πÁõÆÂΩïÈ°π
            let displayFolders = currentFolders.filter(f => {
                if (currentRoot && f.path === currentRoot.path) return false;
                if (f.depth === -1) return false;
                return true;
            });

            // 3. ÊéíÂ∫èÈÄªËæë
            if (sortConfig.key) {
                displayFolders.sort((a, b) => {
                    let valA = a[sortConfig.key];
                    let valB = b[sortConfig.key];
                    if (typeof valA === 'string') {
                        return sortConfig.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    }
                    return sortConfig.direction === 'asc' ? valA - valB : valB - valA;
                });
            }

            // 4. Ê∏≤ÊüìÂ≠êÁõÆÂΩïÂàóË°®
            displayFolders.forEach(folder => {
                const div = document.createElement('div');
                const depth = folder.depth; 
                div.className = `folder-item folder-depth-${depth}`;
                const safeId = getSafeId(folder.path);
                div.innerHTML = `
                    <input type="checkbox" id="folder-${safeId}" value="${folder.path}" ${isAllSelected ? 'checked' : ''}>
                    <div class="folder-label-container">
                        <span class="folder-icon">üìÅ</span>
                        <label for="folder-${safeId}">
                            <span class="folder-name-text">${folder.name}</span>
                            <span class="folder-path-text">${folder.path}</span>
                        </label>
                    </div>
                    <span class="folder-mtime">${formatTime(folder.mtime)}</span>
                `;
                folderList.appendChild(div);
            });

            // 5. Ê∏≤ÊüìÂΩìÂâçÁõÆÂΩï‰∏ãÁöÑÂõæÁâá (Â¶ÇÊûúÂ≠òÂú®)
            if (currentFiles && currentFiles.length > 0) {
                currentFiles.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'folder-item file-item';
                    const safeId = getSafeId(file.path);
                    div.innerHTML = `
                        <input type="checkbox" id="file-${safeId}" value="${file.path}" ${isAllSelected ? 'checked' : ''}>
                        <div class="folder-label-container">
                            <span class="folder-icon">üñºÔ∏è</span>
                            <label for="file-${safeId}">
                                <span class="folder-name-text">${file.name}</span>
                                <span class="folder-path-text">${file.path}</span>
                            </label>
                        </div>
                        <span class="folder-mtime">-</span>
                    `;
                    folderList.appendChild(div);
                });
            }

            // 6. Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÂÜÖÂÆπÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ
            if (displayFolders.length === 0 && (!currentFiles || currentFiles.length === 0)) {
                const empty = document.createElement('div');
                empty.className = 'folder-item';
                empty.style.gridTemplateColumns = '1fr';
                empty.style.textAlign = 'center';
                empty.style.color = '#80868b';
                empty.style.padding = '40px';
                empty.textContent = currentLang === 'zh' ? 'Ê≤°ÊúâÂèëÁé∞ÂèØÂéãÁº©ÁöÑÂõæÁâáÊñá‰ª∂ÊàñÊñá‰ª∂Â§π' : 'No compressible images or folders found';
                folderList.appendChild(empty);
            }

            // 7. ÈáçÊñ∞ÁªëÂÆöÂ§çÈÄâÊ°Ü‰∫ã‰ª∂
            folderList.querySelectorAll('input').forEach(cb => {
                cb.addEventListener('change', () => {
                    const allCbs = folderList.querySelectorAll('input');
                    const checkedCbs = folderList.querySelectorAll('input:checked');
                    selectAllCheckbox.checked = (allCbs.length > 0 && checkedCbs.length === allCbs.length);
                    compressBtn.style.display = checkedCbs.length > 0 ? 'block' : 'none';
                });
            });

            // ÈªòËÆ§ÊåâÈíÆÊòæÁ§∫ÈÄªËæë
            const checkedCbs = folderList.querySelectorAll('input:checked');
            compressBtn.style.display = checkedCbs.length > 0 ? 'block' : 'none';
        }

        function updateSortUI() {
            [sortNameBtn, sortTimeBtn].forEach(btn => {
                btn.classList.remove('sort-asc', 'sort-desc');
            });
            if (sortConfig.key) {
                const btn = sortConfig.key === 'name' ? sortNameBtn : sortTimeBtn;
                btn.classList.add(sortConfig.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }

        sortNameBtn.addEventListener('click', () => {
            if (sortConfig.key === 'name') {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = 'name';
                sortConfig.direction = 'asc';
            }
            updateSortUI();
            renderFolderList();
        });

        sortTimeBtn.addEventListener('click', () => {
            if (sortConfig.key === 'mtime') {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = 'mtime';
                sortConfig.direction = 'asc';
            }
            updateSortUI();
            renderFolderList();
        });

        selectAllCheckbox.addEventListener('change', (e) => {
            isAllSelected = e.target.checked;
            folderList.querySelectorAll('input').forEach(cb => cb.checked = isAllSelected);
            compressBtn.style.display = isAllSelected ? 'block' : 'none';
        });

        function getSafeId(str) {
            // ‰ΩøÁî® encodeURIComponent Â§ÑÁêÜÈùû ASCII Â≠óÁ¨¶ÔºåÁÑ∂ÂêéÊõøÊç¢Êéâ‰∏çËÉΩ‰Ωú‰∏∫ ID ÁöÑÂ≠óÁ¨¶
            return 'id-' + encodeURIComponent(str).replace(/%/g, '_').replace(/\./g, '-');
        }

        function updateProgress(current, total) {
            const langData = i18n[currentLang];
            const curr = parseInt(current) || 0;
            const tot = parseInt(total) || 0;
            let percent = tot > 0 ? Math.round((curr / tot) * 100) : 0;
            if (percent > 100) percent = 100;
            
            progressBarFill.style.width = `${percent}%`;
            progressStats.textContent = `${curr} / ${tot} (${percent}%)`;
            progressTitle.textContent = percent === 100 ? langData.processingComplete : langData.optimizing;
        }

        function initSSE() {
            if (eventSource) {
                eventSource.onmessage = null;
                eventSource.onerror = null;
                eventSource.close();
                eventSource = null;
            }
            
            // Âª∂Ëøü‰∏ÄÂ∞èÊÆµÊó∂Èó¥ÂàùÂßãÂåñÔºåÁ°Æ‰øùÈ°µÈù¢Âä†ËΩΩÁ®≥ÂÆö
            setTimeout(() => {
                eventSource = new EventSource('/progress');
                
                eventSource.onerror = (err) => {
                    console.warn("SSE connection error, closing to retry...");
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                    // 3ÁßíÂêéÂ∞ùËØïÈáçÊñ∞ËøûÊé•
                    setTimeout(initSSE, 3000);
                };

                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    const langData = i18n[currentLang];
                    
                    switch(data.type) {
                        case 'init':
                            if (data.status === 'running' || data.status === 'paused') {
                                showJobUI();
                                updateProgress(data.current, data.total);
                                if (data.status === 'paused') {
                                    pauseBtn.style.display = 'none';
                                    resumeBtn.style.display = 'inline-flex';
                                    progressTitle.textContent = langData.taskPaused;
                                }
                            }
                            break;

                        case 'status':
                            if (data.status === 'running') {
                                showJobUI();
                                updateProgress(0, data.total);
                                pauseBtn.style.display = 'inline-flex';
                                resumeBtn.style.display = 'none';
                                progressTitle.textContent = langData.optimizing;
                                addLog(langData.startBtn + '...', 'info');
                            } else if (data.status === 'paused') {
                                pauseBtn.style.display = 'none';
                                resumeBtn.style.display = 'inline-flex';
                                progressTitle.textContent = langData.taskPaused;
                            } else if (data.status === 'completed') {
                                updateProgress(data.total, data.total);
                                finishJob(data.results);
                            } else if (data.status === 'cancelled') {
                                resetUI();
                            }
                            break;

                        case 'log':
                            addLog(data.message, 'info');
                            break;

                        case 'progress':
                            updateProgress(data.current, data.total);
                            
                            if (data.result) {
                                const res = data.result;
                                const statusText = res.status === 'success' ? langData.optimized : langData.failed;
                                addLog(`${statusText}: ${res.file} (${res.originalSize} ‚Üí ${res.newSize || 'Error'})`, res.status);
                            }
                            break;
                    }
                };
            }, 500); // Â¢ûÂä†Âª∂ËøüÂà∞ 500ms
        }

        function showJobUI() {
            folderTree.style.display = 'none';
            compressBtn.style.display = 'none'; // ÈöêËóèÂéãÁº©ÊåâÈíÆ
            progressCard.style.display = 'block';
            logCard.style.display = 'block';
            resultDiv.style.display = 'none';
            // Á°Æ‰øùÊªöÂä®Âà∞ËøõÂ∫¶Âç°Áâá‰ΩçÁΩÆ
            progressCard.scrollIntoView({ behavior: 'smooth' });
        }

        function resetUI() {
            const langData = i18n[currentLang];
            progressCard.style.display = 'none';
            resultDiv.style.display = 'none';
            folderTree.style.display = 'block';
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÁöÑÈ°πÔºåÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ÂéãÁº©ÊåâÈíÆ
            const checkedCbs = folderList.querySelectorAll('input:checked');
            compressBtn.style.display = checkedCbs.length > 0 ? 'block' : 'none';
            compressBtn.disabled = false;
            compressBtn.style.opacity = '1';
            
            progressBarFill.style.width = '0%';
            logContainer.innerHTML = '';
            cancelBtn.textContent = langData.cancel;
        }

        function finishJob(results) {
            const langData = i18n[currentLang];
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            cancelBtn.textContent = langData.close;
            
            resultDiv.style.display = 'block';
            
            let html = `<div style="font-weight:500; font-size:1.25rem; color:var(--gemini-green);">${langData.successTitle}</div>`;
            html += `<div style="color:var(--text-secondary); font-size:14px; margin-top:4px;">${langData.processedCount.replace('{count}', results.length)}</div>`;
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>${langData.tableFile}</th>
                            <th>${langData.tableOriginal}</th>
                            <th>${langData.tableOptimized}</th>
                            <th>${langData.tableStatus}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.slice(0, 8).forEach(res => { 
                html += `
                    <tr>
                        <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${res.file}</td>
                        <td>${res.originalSize || '-'}</td>
                        <td>${res.newSize || '-'}</td>
                        <td><span class="badge badge-${res.status === 'success' ? 'success' : 'error'}">${res.status === 'success' ? langData.tableSuccess : langData.tableError}</span></td>
                    </tr>
                `;
            });
            
            if (results.length > 8) {
                html += `<tr><td colspan="4" style="text-align:center; color:#80868b; font-size:12px;">${langData.checkLog}</td></tr>`;
            }
            
            html += `</tbody></table>`;
            resultDiv.innerHTML = html;
            addLog(langData.processingComplete + '!', 'success');
        }

        // È°µÈù¢Âç∏ËΩΩÂâçÊ∏ÖÁêÜËøûÊé•
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });

        initSSE();

        pauseBtn.addEventListener('click', async () => {
            await fetch('/job/pause', { method: 'POST' });
        });

        resumeBtn.addEventListener('click', async () => {
            await fetch('/job/resume', { method: 'POST' });
        });

        cancelBtn.addEventListener('click', async () => {
            const langData = i18n[currentLang];
            if (cancelBtn.textContent === langData.cancel) {
                if (!confirm(langData.cancelConfirm)) return;
                await fetch('/job/cancel', { method: 'POST' });
            }
            resetUI();
        });

        scanBtn.addEventListener('click', async () => {
            const langData = i18n[currentLang];
            const folderPath = folderPathInput.value.trim();
            if (!folderPath) return;

            scanBtn.disabled = true;
            scanBtn.innerHTML = `<div class="spinner"></div> ${langData.scanning}`;

            try {
                const response = await fetch('/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folderPath })
                });

                const data = await response.json();
                if (response.ok) {
                    currentFolders = data.folders || [];
                    currentFiles = data.files || [];
                    currentRoot = data.root || null;
                    isAllSelected = false;
                    selectAllCheckbox.checked = false;
                    folderTree.style.display = 'block';
                    renderFolderList();
                } else {
                    alert(data.error || 'Scan failed');
                }
            } catch (error) {
                console.error('Scan error:', error);
                alert('Scan failed');
            } finally {
                scanBtn.disabled = false;
                scanBtn.textContent = langData.scanBtn;
            }
        });

        compressBtn.addEventListener('click', async () => {
            const langData = i18n[currentLang];
            let selectedPaths = Array.from(folderList.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            // Â¶ÇÊûúÂÖ®ÈÄâ‰∫ÜÂ≠êÁõÆÂΩïÔºåÊàñËÄÖÁî®Êà∑ÊúüÊúõÔºåËøôÈáåÂèØ‰ª•ÂåÖÂê´Ê†πÁõÆÂΩï
            // Âú®ÈÄªËæë‰∏äÔºåÂ¶ÇÊûúÂÖ®ÈÄâ‰∫ÜÔºåÊàë‰ª¨Â∞±Êää root.path ‰πüÂä†ËøõÂéªÔºàÂ¶ÇÊûúÂÆÉ‰∏çÂú®ÂàóË°®ÈáåÔºâ
            if (isAllSelected && currentRoot) {
                if (!selectedPaths.includes(currentRoot.path)) {
                    selectedPaths.push(currentRoot.path);
                }
            }

            if (selectedPaths.length === 0) return;

            // ÂàáÊç¢Âà∞‰ªªÂä°ÁïåÈù¢
            showJobUI();
            
            // Ê∏ÖÁêÜ‰πãÂâçÁöÑÊó•ÂøóÂíåËøõÂ∫¶
            logContainer.innerHTML = '';
            updateProgress(0, 100); // ÈáçÁΩÆÊÄªËøõÂ∫¶Êù°

            addLog(langData.initLog.replace('{count}', selectedPaths.length));

            try {
                const response = await fetch('/compress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selectedPaths })
                });

                if (!response.ok) {
                    const data = await response.json();
                    addLog(`Failed: ${data.error}`, 'error');
                    // Êä•ÈîôÊó∂‰∏çÈáçÁΩÆ UIÔºåËÆ©Áî®Êà∑ÁúãÂà∞Êó•Âøó
                    compressBtn.disabled = false;
                    compressBtn.style.opacity = '1';
                }
            } catch (error) {
                addLog(langData.networkError, 'error');
                compressBtn.disabled = false;
                compressBtn.style.opacity = '1';
            }
        });
    </script>
</body>
</html>